Complete refactored version of the file with all improvements applied